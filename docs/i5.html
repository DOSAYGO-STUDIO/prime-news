<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="origin">
    <title>Primes of Hacker News</title>
    <link rel="icon" type="image/svg+xml" href="favicon.png">
    <style>
        /* THE AUTHENTIC HN STYLESHEET */
        body { 
            font-family: Verdana, Geneva, sans-serif; 
            font-size: 10pt; 
            color: #828282; 
            margin: 0; 
            background-color: white; 
        }
        @media(min-width: 768px) { body { margin: 8px; } }
        
        table { border-collapse: collapse; }
        
        /* Main Container */
        #hnmain { 
            background-color: #f6f6ef; 
            width: 85%; 
            min-width: 800px;
            margin: auto; 
        }
        @media(max-width: 768px) { #hnmain { width: 100%; min-width: 0; } }

        /* header */
        td.bgcolor { background-color: #ff6600; }
        .pagetop { font-family: Verdana, Geneva, sans-serif; font-size: 10pt; color: #222222; }
        .pagetop a:visited { color: #000000; }
        .pagetop a { color: #000000; text-decoration: none; }
        .hnname { font-weight: bold; margin-right: 10px;}
        
        /* Links */
        a:link { color: #000000; text-decoration: none; }
        a:visited { color: #828282; text-decoration: none; }
        a:hover { text-decoration: underline; }

        /* Item List Styling */
        .itemlist { padding-right: 10px; }
        .rank { font-size: 10pt; color: #828282; text-align: right; padding-right: 5px; vertical-align: top;}
        .title { font-size: 10pt; color: #828282; overflow: hidden; }
        .titleline { overflow: hidden; }
        .titleline a { color: #000000; }
        .titleline a:visited { color: #828282; }
        
        .subtext { font-family: Verdana, Geneva, sans-serif; font-size: 7pt; color: #828282; }
        .subtext a { color: #828282; text-decoration: none; }
        .subtext a:hover { text-decoration: underline; }
        .score { color: #828282; }
        
        .spacer { height: 5px; }
        .morelink { font-family: Verdana, Geneva, sans-serif; font-size: 10pt; color: #000000; text-decoration: none; padding-left: 15px;}
        
        /* Footer Links */
        .yclinks { font-family: Verdana, Geneva, sans-serif; font-size: 8pt; color: #828282; }
        .yclinks a { color: #828282; text-decoration: none; }
        .yclinks a:hover { text-decoration: underline; }

        /* Search Box styling */
        input { font-family: monospace; font-size: 10pt; border: 1px solid #828282; padding: 2px; }

        /* Loading / Status */
        #status-bar { background: #fff; padding: 5px; text-align: center; display: none; border-bottom: 1px solid #ccc; font-family: monospace;}
        
        /* Zeta Symbol style */
        .zeta-logo {
            border: 1px solid white; 
            width: 18px; 
            height: 18px; 
            color: white; 
            text-align: center; 
            line-height: 18px; 
            font-size: 12pt; 
            font-family: 'Times New Roman', serif;
            display: block;
        }
    </style>
</head>
<body>

<center>
    <div id="status-bar">Initializing DB...</div>
    <table id="hnmain" border="0" cellpadding="0" cellspacing="0">
        <!-- HEADER -->
        <tr>
            <td class="bgcolor">
                <table style="padding:2px" width="100%" border="0" cellpadding="0" cellspacing="0">
                    <tr>
                        <td style="width:18px; padding-right:4px">
                            <a href="index.html">
                              <div class="zeta-logo">ζ</div>
                            </a>
                        </td>
                        <td style="line-height:12pt; height:10px;">
                            <span class="pagetop">
                                <b class="hnname"><a href="index.html">Primes of Hacker News</a></b>
                                <a href="index.html">new</a> | <a href="#">past</a> | <a href="#">comments</a> | <a href="#">submit</a>
                            </span>
                        </td>
                        <td style="text-align:right; padding-right:4px;">
                            <span class="pagetop">
                                <a href="https://news.ycombinator.com/login">login</a>
                            </span>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
        
        <!-- SPACER -->
        <tr style="height:10px"></tr>

        <!-- CONTENT -->
        <tr>
            <td>
                <table border="0" cellpadding="0" cellspacing="0" class="itemlist" id="content-table">
                    <!-- Items injected here -->
                    <tr><td style="padding:20px">Loading Prime Lattice...</td></tr>
                </table>
            </td>
        </tr>

        <!-- FOOTER -->
        <tr>
            <td>
                <img src="https://news.ycombinator.com/s.gif" height="10" width="0"><table width="100%" cellspacing="0" cellpadding="1"><tr><td class="bgcolor"></td></tr></table><br>
                <center>
                    <span class="yclinks">
                        <a href="#">Pure Math</a> | 
                        <a href="#">Deterministic</a> | 
                        <a href="#">Stateless</a> | 
                        <a href="#">API</a> | 
                        <a href="#">Security</a> | 
                        <a href="#">Legal</a> | 
                        <a href="#">Apply to ζ</a> | 
                        <a href="#">Contact</a>
                    </span>
                    <br><br>
                    <form onsubmit="event.preventDefault(); jumpToPrime();">
                        Jump to neighborhood: 
                        <input type="number" id="jumpInput" size="17" autocorrect="off" spellcheck="false" autocapitalize="off" autocomplete="off" placeholder="e.g. 1000000">
                    </form>
                </center>
                <br>
            </td>
        </tr>
    </table>
</center>

<!-- LOGIC -->
<script src="jswasm/sqlite3.js"></script>
<script>
    let db = null;
    let manifest = null;
    let currentShardIdx = -1;
    let sqlite3 = null; // Global handle for double-probe
    const ITEMS_PER_PAGE = 30;

    const urlParams = new URLSearchParams(window.location.search);
    let currentPage = parseInt(urlParams.get('p') || 1);

    const statusEl = document.getElementById('status-bar');
    const tableEl = document.getElementById('content-table');

    async function maybeGunzip(u8) {
        // gzip header 1f 8b
        if (u8.length >= 2 && u8[0] === 0x1f && u8[1] === 0x8b) {
            if (typeof DecompressionStream !== 'undefined') {
                const ds = new DecompressionStream('gzip');
                const stream = new Response(u8).body.pipeThrough(ds);
                const buf = await new Response(stream).arrayBuffer();
                return new Uint8Array(buf);
            }
            if (typeof pako !== 'undefined') {
                return pako.ungzip(u8);
            }
            throw new Error('gzip not supported in this browser');
        }
        return u8;
    }

    async function fetchShardBytes(shardIdx) {
        const base = `shards/shard_${shardIdx}.sqlite`;
        let response = await fetch(`${base}.gz`, { cache: 'force-cache' });
        if (response.ok) {
            const u8 = new Uint8Array(await response.arrayBuffer());
            return await maybeGunzip(u8);
        }
        if (response.status !== 404) {
            throw new Error(`fetch failed ${response.status}: ${base}.gz`);
        }
        response = await fetch(base, { cache: 'force-cache' });
        if (!response.ok) throw new Error(`fetch failed ${response.status}: ${base}`);
        return new Uint8Array(await response.arrayBuffer());
    }

    // --- MATH HELPERS ---

    // A simple seeded RNG (Mulberry32) so scores are constant per ID
    function seededRandom(seed) {
        let t = seed + 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    }

    // Generate a score based on HN distribution (Power Law / Exponential)
    function generateCommentScore(id) {
        const r = seededRandom(id);
        let score = Math.floor(-Math.log(1 - r) * 1.5) + 1;
        if (score > 100) score = 100; // Cap outliers
        return score;
    }

    // --- CONFIG ---
    const DEBUG = false;  // Set true to show alert modals during jump
    const ESTIMATOR = 'legendre'; // Options: 'pnt', 'legendre', 'li'

    const Estimators = {
        // Basic Prime Number Theorem: π(x) ≈ x / ln(x)
        pnt: function(x) {
            if (x < 2) return 0;
            return x / Math.log(x);
        },

        // Legendre's Formula: π(x) ≈ x / (ln(x) - 1.08366)
        // More accurate for x in the millions
        legendre: function(x) {
            if (x < 2) return 0;
            return x / (Math.log(x) - 1.08366);
        },

        // Logarithmic Integral Asymptotic Expansion
        // Li(x) ≈ x/ln(x) * (1 + 1!/ln(x) + 2!/ln²(x) + 3!/ln³(x) + ...)
        li: function(x) {
            if (x < 2) return 0;
            const lnx = Math.log(x);
            const lnx2 = lnx * lnx;
            const lnx3 = lnx2 * lnx;
            const lnx4 = lnx3 * lnx;
            const lnx5 = lnx4 * lnx;
            // Asymptotic series: 1 + 1!/ln + 2!/ln² + 3!/ln³ + 4!/ln⁴ + 5!/ln⁵
            const series = 1 + 1/lnx + 2/lnx2 + 6/lnx3 + 24/lnx4 + 120/lnx5;
            return (x / lnx) * series;
        }
    };

    // Get the active estimator
    function estimatePrimeCount(x) {
        return Math.floor(Estimators[ESTIMATOR](x));
    }

    // --- THE ITERATIVE PROBE ---
    // π(target) - π(landing) = primes to jump over
    async function jumpToPrime() {
        const target = parseInt(document.getElementById('jumpInput').value);
        if (!target || target < 2) return;

        statusEl.style.display = 'block';
        const maxShard = Math.ceil(manifest.totalPrimes / manifest.shardSize) - 1;
        const log = [];  // collect debug info

        // Helper: load a page and get the first prime on it
        async function loadPage(pageNum) {
            const startIdx = (pageNum - 1) * ITEMS_PER_PAGE;
            const shardIdx = Math.max(0, Math.min(Math.floor(startIdx / manifest.shardSize), maxShard));

            let raw;
            try {
                raw = await fetchShardBytes(shardIdx);
            } catch (e) {
                return null;
            }
            const p = sqlite3.wasm.allocFromTypedArray(raw);
            const tempDb = new sqlite3.oo1.DB();
            sqlite3.capi.sqlite3_deserialize(
                tempDb.pointer, "main", p, raw.byteLength, raw.byteLength,
                sqlite3.capi.SQLITE_DESERIALIZE_FREEONCLOSE
            );

            // Get first and last prime on THIS PAGE (not shard)
            const rows = tempDb.exec({
                sql: "SELECT idx, id FROM items WHERE idx >= ? AND idx < ? ORDER BY idx ASC",
                bind: [startIdx, startIdx + ITEMS_PER_PAGE],
                rowMode: 'object',
                returnValue: "resultRows"
            });
            tempDb.close();

            if (!rows || rows.length === 0) return null;
            return {
                firstId: rows[0].id,
                firstIdx: rows[0].idx,
                lastId: rows[rows.length - 1].id,
                lastIdx: rows[rows.length - 1].idx
            };
        }

        // Check if target is on this page
        function targetOnPage(page, target) {
            return page && target >= page.firstId && target <= page.lastId;
        }

        try {
            const piTarget = estimatePrimeCount(target);
            let currentPage = Math.max(1, Math.floor(piTarget / ITEMS_PER_PAGE) + 1);
            let iteration = 0;
            const MAX_ITERATIONS = 10;

            log.push(`TARGET: ${target}`);
            log.push(`π(${target}) ≈ ${piTarget}`);
            log.push(`---`);

            while (iteration < MAX_ITERATIONS) {
                iteration++;
                statusEl.innerText = `[${ESTIMATOR.toUpperCase()}] Iteration ${iteration}: Loading page ${currentPage}...`;

                const page = await loadPage(currentPage);
                if (!page) {
                    log.push(`Iter ${iteration}: Page ${currentPage} failed to load`);
                    break;
                }

                log.push(`Iter ${iteration}: Page ${currentPage}`);
                log.push(`  Range: ${page.firstId} - ${page.lastId}`);

                // Check if we found it
                if (target >= page.firstId && target <= page.lastId) {
                    log.push(`  ✓ TARGET FOUND ON PAGE!`);
                    log.push(`---`);
                    log.push(`Total iterations: ${iteration}`);
                    if (DEBUG) alert(log.join('\n'));
                    console.log(log.join('\n'));
                    window.location.search = `?p=${currentPage}`;
                    return;
                }

                // Calculate correction using DIFFERENCE of estimators
                let landingId, direction;
                if (page.lastId < target) {
                    // UNDERSHOT - use last prime on page
                    landingId = page.lastId;
                    direction = 1;
                    log.push(`  UNDERSHOT by ${target - landingId}`);
                } else {
                    // OVERSHOT - use first prime on page
                    landingId = page.firstId;
                    direction = -1;
                    log.push(`  OVERSHOT by ${landingId - target}`);
                }

                // THE KEY: π(target) - π(landing) = primes between them
                const piLanding = estimatePrimeCount(landingId);
                const primesToJump = Math.abs(piTarget - piLanding);
                const pageJump = Math.max(1, Math.floor(primesToJump / ITEMS_PER_PAGE));

                log.push(`  π(${target}) = ${piTarget}`);
                log.push(`  π(${landingId}) = ${piLanding}`);
                log.push(`  Δπ = ${primesToJump} primes → ${pageJump} pages`);

                currentPage = Math.max(1, currentPage + direction * pageJump);
                log.push(`  Next page: ${currentPage}`);
                log.push(`---`);
            }

            log.push(`Stopped after ${iteration} iterations`);
            if (DEBUG) alert(log.join('\n'));
            console.log(log.join('\n'));
            window.location.search = `?p=${currentPage}`;

        } catch (e) {
            console.error("Probe failed:", e);
            log.push(`ERROR: ${e.message}`);
            if (DEBUG) alert(log.join('\n'));
            console.log(log.join('\n'));
            const fallbackPage = Math.max(1, Math.floor(estimatePrimeCount(target) / ITEMS_PER_PAGE) + 1);
            window.location.search = `?p=${fallbackPage}`;
        }
    }

    // --- UTILITIES ---

    function timeAgo(ts) {
        if (!ts) return '';
        const seconds = Math.floor(Date.now() / 1000) - ts;
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + " years ago";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + " months ago";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + " days ago";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + " hours ago";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + " minutes ago";
        return Math.floor(seconds) + " seconds ago";
    }

    // Tiny helper for client-side snippet generation
    function getSnippet(html) {
         if (!html) return '[Comment]';
         let text = html.replace(/<[^>]+>/g, ' ');
         text = text.replace(/&quot;/g, '"').replace(/&#x27;/g, "'").replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&');
         text = text.replace(/\s+/g, ' ').trim();
         if (text.length > 80) return text.substring(0, 80) + '...';
         return text || '[Comment]';
    }

    // --- CORE LOGIC ---

    async function init() {
        try {
            manifest = await fetch('manifest.json').then(r => r.json());
            sqlite3 = await window.sqlite3InitModule();
            await loadPage(currentPage);
        } catch (e) {
            tableEl.innerHTML = `<tr><td style="padding:20px">Error loading Prime HN: ${e.message}</td></tr>`;
        }
    }

    async function loadPage(page) {
        statusEl.style.display = 'block';
        
        const startIdx = (page - 1) * ITEMS_PER_PAGE;
        const endIdx = startIdx + ITEMS_PER_PAGE;

        if (startIdx >= manifest.totalPrimes) {
            await renderLiveMode(startIdx, endIdx);
            statusEl.style.display = 'none';
            return;
        }

        const requiredShard = Math.floor(startIdx / manifest.shardSize);

        if (currentShardIdx !== requiredShard) {
            statusEl.innerText = `Loading Shard ${requiredShard} of ${Math.ceil(manifest.totalPrimes/manifest.shardSize)}...`;
            const raw = await fetchShardBytes(requiredShard);
            const p = sqlite3.wasm.allocFromTypedArray(raw);
            
            if (db) db.close();
            db = new sqlite3.oo1.DB();
            
            sqlite3.capi.sqlite3_deserialize(
                db.pointer, "main", p, raw.byteLength, raw.byteLength, 
                sqlite3.capi.SQLITE_DESERIALIZE_FREEONCLOSE
            );
            currentShardIdx = requiredShard;
        }

        statusEl.style.display = 'none';

        const rows = db.exec({
            sql: "SELECT * FROM items WHERE idx >= ? AND idx < ? ORDER BY idx ASC",
            bind: [startIdx, endIdx],
            rowMode: 'object',
            returnValue: "resultRows"
        });

        renderRows(rows, startIdx);
    }

    function renderRows(items, startRankIndex) {
        let html = '';
        items.forEach((item, i) => {
            const rank = startRankIndex + i + 1;
            let scoreDisplay = item.score + " points";
            let scoreClass = "score";
            
            if (item.type === 'comment' || item.score === 0) {
                 const synthScore = generateCommentScore(item.id);
                 scoreDisplay = `<span title="Estimated via Power Law (~${synthScore})">${synthScore} points</span>`;
            }

            let displayTitle = item.title;
            let url = `https://news.ycombinator.com/item?id=${item.id}`; 
            
            html += `
                <tr class="athing" id="${item.id}">
                    <td align="right" valign="top" class="title"><span class="rank">${rank}.</span></td>
                    <td valign="top" class="votelinks"><center><a href="https://news.ycombinator.com/item?id=${item.id}"><div class="votearrow" title="upvote"></div></a></center></td>
                    <td class="title">
                        <span class="titleline"><a href="${url}">${displayTitle}</a></span>
                    </td>
                </tr>
                <tr>
                    <td colspan="2"></td>
                    <td class="subtext">
                        <span class="subline">
                            <span class="${scoreClass}" id="score_${item.id}">${scoreDisplay}</span> 
                            by <a href="https://news.ycombinator.com/user?id=${item.user}" class="hnuser">${item.user}</a> 
                            <span class="age" title="${new Date(item.time*1000).toISOString()}">
                                <a href="https://news.ycombinator.com/item?id=${item.id}">${timeAgo(item.time)}</a>
                            </span> | 
                            <a href="https://www.wolframalpha.com/input?i=${item.id}" target="_blank" title="View Prime Properties on WolframAlpha">ζ(${item.id})</a>
                        </span>
                    </td>
                </tr>
                <tr class="spacer" style="height:5px"></tr>
            `;
        });
        
        html += `<tr class="morespace" style="height:10px"></tr><tr><td colspan="2"></td><td class="title"><a href="?p=${currentPage + 1}" class="morelink" rel="next">More</a></td></tr>`;
        tableEl.innerHTML = html;
    }

    function isPrime(num) {
        if (num % 2 === 0) return false;
        if (num % 3 === 0) return false;
        const limit = Math.sqrt(num);
        for (let i = 5; i <= limit; i += 6) {
            if (num % i === 0 || num % (i + 2) === 0) return false;
        }
        return true;
    }

    async function renderLiveMode(startIdx, endIdx) {
        statusEl.style.display = 'block';
        let maxItem = 0;
        try {
            statusEl.innerText = "Contacting Live API...";
            maxItem = await fetch('https://hacker-news.firebaseio.com/v0/maxitem.json').then(r => r.json());
            maxItem = parseInt(maxItem); 
        } catch(e) {
            tableEl.innerHTML = '<tr><td style="padding:20px">Error reaching HN API.</td></tr>';
            return;
        }

        const primesFound = [];
        let candidate = parseInt(manifest.maxId) + 1;
        const neededPrimes = endIdx - startIdx; 
        const primesToSkip = startIdx - manifest.totalPrimes;
        let skipped = 0;
        const HARD_LIMIT = 5_000_000; 
        let checks = 0;
        
        tableEl.innerHTML = `<tr><td colspan="3" style="padding:40px; text-align:center; color:#828282">
                <h3>Bridging the Gap</h3>
                <p>Static DB ends: ${manifest.maxId}</p>
                <p>Live API ends: ${maxItem}</p>
                <div style="margin:20px; font-family:monospace; font-size:1.2em;" id="mining-status">Warp Drive Active...</div>
            </td></tr>`;
        const miningStatus = document.getElementById('mining-status');

        if (candidate > maxItem) {
             tableEl.innerHTML = `<tr><td style="padding:20px">Live API is behind Static DB.</td></tr>`;
             return;
        }

        while (primesFound.length < neededPrimes && candidate <= maxItem && checks < HARD_LIMIT) {
            if (checks % 5000 === 0) {
                miningStatus.innerText = `Scanning ID: ${candidate} | Found: ${primesFound.length}/${neededPrimes}`;
                await new Promise(r => setTimeout(r, 0));
            }
            if (isPrime(candidate)) {
                if (skipped < primesToSkip) skipped++;
                else primesFound.push({id: candidate, idx: startIdx + primesFound.length});
            }
            candidate++;
            checks++;
        }

        if (primesFound.length === 0) {
            if (skipped > 0) {
                 tableEl.innerHTML = `<tr><td style="padding:20px; text-align:center">Scanning complete. Found ${skipped} primes (skipped), but reached current time.</td></tr>`;
                 statusEl.style.display = 'none';
                 return;
            }
            tableEl.innerHTML = `<tr><td style="padding:20px; text-align:center;"><h3>The End of the Universe</h3><p>Current Max ID: ${maxItem}</p><p>Waiting for the next prime...</p></td></tr>`;
            statusEl.style.display = 'none';
            return;
        }

        statusEl.innerText = `Fetching content for ${primesFound.length} new items...`;
        const liveItems = [];
        for (let i = 0; i < primesFound.length; i += 10) {
            const batch = primesFound.slice(i, i + 10);
            const batchResults = await Promise.all(batch.map(p => fetch(`https://hacker-news.firebaseio.com/v0/item/${p.id}.json`).then(r => r.json())));
            liveItems.push(...batchResults);
        }

        const rows = liveItems.map((item, i) => {
            if (!item) return null;
            return {
                id: item.id,
                title: item.title || (item.text ? getSnippet(item.text) : '[Untitled]'),
                user: item.by || 'anon',
                score: item.score || 0,
                time: item.time,
                type: item.type,
                idx: startIdx + i
            };
        }).filter(x => x);

        statusEl.style.display = 'none';
        renderRows(rows, startIdx);
    }

    init();
</script>
</body>
</html>
